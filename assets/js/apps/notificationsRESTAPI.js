(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=o(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,a=function(){};return{s:a,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){c=!0,r=t},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw r}}}}function n(t){return function(t){if(Array.isArray(t))return i(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||o(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(t,e){if(t){if("string"==typeof t)return i(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?i(t,e):void 0}}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,o=new Array(e);n<e;n++)o[n]=t[n];return o}function a(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,r(o.key),o)}}function r(e){var n=function(e,n){if("object"!=t(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,n||"default");if("object"!=t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==t(n)?n:String(n)}const s=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.POPUP_HASH="notifications",this.UNREAD_COUNT="unread-notifications-count",this.PER_PAGE=9,768>screen.width&&(this.PER_PAGE=5),wp.api.init({versionString:"kagg/v1/"}),document.getElementsByClassName("notifications-content")[0]?this.getNotifications([]):"#"+this.POPUP_HASH===window.location.hash.split("?")[0]?this.showPopup():this.bindEvents()}var o,i,r;return o=t,i=[{key:"getNotificationListElement",value:function(){var t=document.querySelector("#notifications-popup");return t?"block"===t.style.display?t.querySelector(".notifications-modal-content tbody"):null:document.querySelector("#notifications-list tbody")}},{key:"changeEventHandler",value:function(){var t=[];n(document.querySelectorAll('select[name="channel"]')).map((function(e){var n=e.options[e.selectedIndex].value;return""!==n&&(t[e.name]=n),!1})),this.getNotifications(t)}},{key:"getNotifications",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.notifications=null,wp.api.loadPromise.done((function(){var n=0,o="";for(var i in e)e.hasOwnProperty(i)&&(o+=(0===n?"?":"&")+i+"="+e[i],n++);var a=wp.api.models.Post.extend({urlRoot:WPAPISettings.root+WPAPISettings.base}),r=wp.api.collections.Posts.extend({url:WPAPISettings.root+WPAPISettings.base+o,model:a});t.notifications=new r;var s=t.notifications;return s.fetch({data:{per_page:t.PER_PAGE},error:function(e,n){t.getNotificationListElement.innerHTML='<td colspan="4" class="notifications-error">'+n.responseJSON.message+"</td>"}}).done((function(){document.querySelector("#more-button").disabled=!s.hasMore(),t.showNotifications(t.notifications)}))}))}},{key:"createNotification",value:function(t){var e=this;wp.api.loadPromise.done((function(){var n=new wp.api.models.Notifications({});for(var o in t)t.hasOwnProperty(o)&&(n.attributes[o]=t[o]);n.save().done((function(){e.getNotifications()}))}))}},{key:"updateNotification",value:function(t){var e=this;wp.api.loadPromise.done((function(){var n=new wp.api.models.Notifications({});for(var o in t)t.hasOwnProperty(o)&&(n.attributes[o]=t[o]);n.set(),n.save().done((function(){e.getNotifications()}))}))}},{key:"deleteNotification",value:function(t){var e=this;wp.api.loadPromise.done((function(){var n=new wp.api.models.Notifications({});n.attributes.id=t,n.destroy().done((function(){e.getNotifications()}))}))}},{key:"showNotifications",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=this.getNotificationListElement();if(n){t.hasMore()&&t.more();var o="";document.querySelector(".notifications-content").classList.contains("edit")&&(o+='<img alt="Delete Button" class="delete-notification-button" src="'+WPAPISettings.pluginURL+'/assets/images/delete-button.svg">',o+='<img alt="Update Button" class="update-notification-button" src="'+WPAPISettings.pluginURL+'/assets/images/update-button.svg">');var i=0,a="";t.each((function(t){var e="";t.attributes.read?e=" read":i++,a+="<tr>",a+='<td class="notification-cell'+e+'">',a+='<div class="notification-content"',a+=' data-id="'+t.attributes.id+'"',a+=' data-channel="'+t.attributes.channel+'"',a+=' data-users="'+t.attributes.users+'"',a+=' data-title="'+t.attributes.title+'"',a+=">",t.attributes.content?a+=t.attributes.content:a+=t.attributes.title,a+="</div>",a+='<div class="notification-data">',a+='<span class="notification-channel">'+t.attributes.channel+"</span>",t.attributes.channel&&(a+=" - "),a+='<span class="notification-date">'+t.attributes.date+"</span>",t.attributes.users&&(a+=" - ",a+='<span class="notification-users">'+t.attributes.users+"</span>"),a+="</div>",a+="</td>",a+="<td>"+o+"</td>",a+="</tr>"})),e?n.innerHTML+=a:n.innerHTML=a,this.updateUnreadCountElements(i),this.bindEvents()}}},{key:"updateUnreadCountElements",value:function(t){for(var e=document.getElementsByClassName(this.UNREAD_COUNT),n=e.length,o=0;o<n;o++)e[o].innerText=9>t?t.toString():"9+",e[o].style.display=t?"inline-block":"none"}},{key:"bindEvents",value:function(){var t,o=this,i=[],a=null,r=function(){return o.updateNotification(i)},s=e(document.getElementsByTagName("a"));try{for(s.s();!(t=s.n()).done;){var c=t.value;this.hasPopupHash(c.hash)&&(c.onclick=function(t){return t.preventDefault(),o.showPopup(),!1})}}catch(t){s.e(t)}finally{s.f()}var u,l=e(document.getElementsByClassName("notification-cell"));try{for(l.s();!(u=l.n()).done;)u.value.onclick=function(t){if("A"===t.target.tagName)return!0;var e=t.target.closest(".notification-cell");e.classList.toggle("read");var n=e.querySelector(".notification-content").dataset.id;return(i=[]).id=n,i.read=e.classList.contains("read"),r(),!1}}catch(t){l.e(t)}finally{l.f()}window.onclick=function(t){if(t.target.matches(".notifications-modal")&&(t.target.style.display="none"),t.target.matches(".close")&&(t.target.closest(".notifications-modal").style.display="none"),t.target.matches("#create-notification-button")&&(document.getElementById("create-modal").style.display="block"),t.target.matches("#create-button")){var e=document.getElementById("title-text").value.trim();if(""===e)return;var n=document.getElementById("content-text").innerHTML.trim();if(""===n)return;document.getElementById("create-modal").style.display="none",(i=[]).title=e,i.content=n,i.channel=document.getElementById("channel-text").value,i.users=document.getElementById("users-text").value,o.createNotification(i)}if(t.target.matches(".update-notification-button")){var s=t.target.closest("tr").getElementsByClassName("notification-content")[0];document.getElementById("update-title-text").value=s.dataset.title,document.getElementById("update-title-text").dataset.id=s.dataset.id,document.getElementById("update-content-text").innerHTML=s.innerHTML,document.getElementById("update-channel-text").value=s.dataset.channel,document.getElementById("update-users-text").value=s.dataset.users,document.getElementById("update-modal").style.display="block"}if(t.target.matches("#update-button")){var c=document.getElementById("update-title-text").value.trim();if(""===c)return;var u=document.getElementById("update-content-text").innerHTML.trim();if(""===u)return;var l=document.getElementById("update-title-text").dataset.id;document.getElementById("update-modal").style.display="none",(i=[]).id=l,i.title=c,i.content=u,i.channel=document.getElementById("update-channel-text").value,i.users=document.getElementById("update-users-text").value,r()}if(t.target.matches(".delete-notification-button")){var d=t.target.closest("tr").getElementsByClassName("notification-content")[0];confirm("Are you sure to delete the following notification?\n\n"+d.innerText)&&(a=d.dataset.id,o.deleteNotification(a))}t.target.matches("#read-button")&&(o.markAllAsReadAjax().then((function(t){var e=document.getElementsByClassName("notification-cell");if("done"===t)for(var n in e)e.item(n).classList.add("read")})),o.getNotifications())},n(document.querySelectorAll('select[name="channel"]')).map((function(t){return t.onchange=function(){return o.changeEventHandler()}}));var d=document.querySelector("#more-button");null!==d&&(d.onclick=function(){d.disabled=!o.notifications.hasMore(),o.showNotifications(o.notifications,!0)}),document.addEventListener("update_unread_counts",(function(t){o.updateUnreadCountElements(t.detail)}))}},{key:"hasPopupHash",value:function(t){return void 0!==t&&""!==t&&this.POPUP_HASH===t.split("#")[1].split("?")[0]}},{key:"getPopupContent",value:function(){var t={action:"kagg_notification_get_popup_content",nonce:WPAPISettings.nonce};return this.ajax(t)}},{key:"showPopup",value:function(){var t=this,e=document.getElementById("notifications-popup");e||((e=document.createElement("div")).id="notifications-popup",e.className="notifications-modal",e.innerHTML='<div class="notifications-modal-content"></div>',document.body.appendChild(e)),this.getPopupContent().then((function(n){e.getElementsByClassName("notifications-modal-content")[0].innerHTML='<span class="close">&times;</span>'+n,e.style.display="block",t.bindEvents(),t.getNotifications(),document.body.appendChild(document.getElementById("create-modal")),document.body.appendChild(document.getElementById("update-modal"))}))}},{key:"markAllAsReadAjax",value:function(){var t={action:"kagg_notification_make_all_as_read",nonce:WPAPISettings.nonce,current_user:document.getElementById("current-user").value};return this.ajax(t)}},{key:"ajax",value:function(t){var e=Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&");return fetch(WPAPISettings.ajaxURL,{method:"POST",body:e,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=utf-8"},credentials:"same-origin"}).then((function(t){if(!t.ok)throw new Error(t.statusText);return t.json()})).then((function(t){if(t.success)return t.data;throw new Error(t.data)})).catch((function(t){return t.message}))}}],i&&a(o.prototype,i),r&&a(o,r),Object.defineProperty(o,"prototype",{writable:!1}),t}();document.addEventListener("DOMContentLoaded",(function(){new s}))})();